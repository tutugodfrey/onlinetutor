<?php 
//include required files
include "./../includes/db_connect.php";
include "./../includes/functions.php";
include "./../includes/server-funcs.php";
include "./../includes/views.php";


session_start();
if(isset($_SESSION["owner_id"])){
$owner_id = $_SESSION["owner_id"];
$heading = "";

if(isset($_GET["tests"])){
	$query_string = "select distinct course_id from questions where lec_id = \"$owner_id\"";
	run_query($query_string);
	if($row_num2 == 0 ){
		$display = "<p>You have not save any course start saving courses</p>";
	}	else 	{
	$course_ids = build_array($row_num2);
	if($row_num2 == 1) {
		$course_ids = [$course_ids];
	}
	$courses = foreach_iterator2("get_course_code", $course_ids,  $owner_id, 2);
	$select_result = select_option($courses, "course code", "course_id", "form-control");
	$heading = "<h1>Select a course to open test</h1>";
	$display = <<<block
	<p> The courses displayed are courses for which test questions have been set</p>
	<form name = "test_form" method = "POST" action = "$_SERVER[PHP_SELF]" >
	$select_result <br /><br />
	<input type = "submit" class = "btn btn-primary" id = "setTest" name = "set_test" value = "Set Test" />
	<input type = "submit" class = "btn btn-secondary" id = "viewTest" name = "view_test" value = "View Test" />
	</form>
block;
	}
}


if(isset($_POST["set_test"]) || isset($_POST["edit_test"])){
	$test_no = ""; $select_result = ""; $date_fields = ""; $save_test = ""; $update_test = "";
	$course_code = ""; $duration = ""; $no_of_question = ""; $mark = "";	$form_text = ""; $type = "";
	$duration = "<label for = \"duration_of_test\">Duration</label>";
	$no_of_question = "<label for = \"number_of_question\" >No of Questions</label>";
	$mark = "<label for = \"mark\">Mark per Question</label>";
	if(!isset($_POST["course_id"])){
		$display = "<p>Please select a course to open a test</p>";
	}	else	{
		$course_id = trim($_POST["course_id"]);
		$course_code = get_course_code($course_id, $owner_id, 1);
		if(isset($_POST["set_test"])){
		$query_string = "select distinct test_id from questions where course_id = \"$course_id\" and lec_id = \"$owner_id\"";
		run_query($query_string);
		if($row_num2 == 0) {
			$form_text = "<p>information about the test could not be fetched </p>";
		}	else	{
		$test_ids = build_array($row_num2);
		if ($row_num2 == 1){
			$test_ids = [$test_ids];
		}
		//$test_no =
		 select_option($test_ids, "test no", "test_id");
		$heading = "<h1>Open A Test</h1>";
		$form_text = "<h3>Test Specifications for $course_code[0]</h3><p>fill the required fields to open a test</p>";

		$type = <<<block
		<label for = "testType">Type</label>
		<select id = "testType" name ="test_type">
		<option value = "test">Test</option>
		<option value = "exam">Exam</option>
		</select><br/>
block;
		$course_code = "<input type = \"hidden\" name = \"course_id\" value = \"$course_id\" /><br/>";
		$duration .= "<input type = \"number\" name = \"duration\" /><br />";
		$no_of_question .= "<input type = \"number\" name = \"no_of_questions\" /><br />";
		$mark .= "<input type = \"number\" name = \"mark\" /><br />";
		$save_test = "<input type = \"submit\" class = \"btn btn-primary\" id = \"setTest\" name = \"set\" value = \"SET\" />";	
		//call function to get date
		$end_year = date("Y");
		date_field("deadline", 31, 12, 2030, $end_year);
		}
	}		//end  open_test
	if(isset($_POST["edit_test"])){
		if(empty($_POST["test_id"])){
			$form_text = "<h3>Test Specifications</h3><p>Please select a test to edit</p>";
		}	else		{
			$test_ind = trim($_POST["test_id"][0]);
			$test_ind = explode(" ", $test_ind);
			$test_id = $test_ind[0];
			$test_type = $test_ind[1];


			$query_string = "select test_id, date_format(duration, \"%i\"), no_of_questions, mark from tests where test_id = \"$test_id\" 
					and course_id = \"$course_id\" and test_type = \"$test_type\" and lec_id = \"$owner_id\"";

			/*
			if($test_id == "exam") {
			$query_string = "select test_id, date_format(duration, \"%i\"), no_of_questions, mark from test where test_type = \"$test_id\" 
					and course_id = \"$course_id\"";
			$add_to_heading = "";
			$type = "exam";
			}	*/
			run_query($query_string);
			if($row_num2 == 0){
				$form_text = "<p>The test could not be found in the record</p>";
			}	else	{
				$result = build_array($row_num2);
				//$test_id = $result["0"];
				$deadline = $result["3"];
				$no_of_questions = $result["no_of_questions"];
				$dmark = $result["mark"];
				$dduration = $result["date_format(duration, \"%i\")"];
				$heading = "<h1>Edit test specification for $course_code $test_type $test_id</h1>";

				$form_text = "<p>fill the required fields to open a test</p>";
				$test_no =  "<input type = \"hidden\" name = \"test_id\" value = \"$test_id\" /><br />";
				$type =  "<input type = \"hidden\" name = \"test_type\" value = \"$test_type\" /><br />";
				$course_code = "<input type = \"hidden\" name = \"course_id\" value = \"$course_id\" />";
				$duration .= "<input type = \"number\" name = \"duration\" value = \"$dduration\" /><br />";
				$no_of_question .= "<input type = \"number\" name = \"no_of_questions\" value = \"$no_of_questions\" /><br />";
				$mark .= "<input type = \"number\" name = \"mark\" value = \"$dmark\" /><br />";
				$update_test = "<input type = \"submit\" class = \"btn btn-primary\" id = \"updateTest\" name = \"update_test\" value = \"Update\" />";	
				$end_year = date("Y");
				date_field("deadline", 31, 12, 2030, $end_year);		//call function to get date
				}
			}
		}
	}  // end edit_test
	$display = <<<block
	$form_text
	<form name = "test_specification" method = "POST" action = "$_SERVER[PHP_SELF]" >
	$course_code
	<!-- test_id is the id that tie a particular set of questions -->
	$select_result  <br /> 	<!-- this contain the test_id -->
	$test_no
	$type
	$duration
	$no_of_question
	$mark
	$date_fields
	$save_test
	$update_test 
	</form>
block;
}



if(isset($_POST["set"]) || isset($_POST["update_test"])){
	$test_id = trim($_POST["test_id"]);
	$duration = trim($_POST["duration"]);
	$mark 	= trim($_POST["mark"]);
	$no_of_questions = trim($_POST["no_of_questions"]);
	//get the date from the select options
	$day = $_POST["day"];
	$mon = $_POST["mon"];
	$year = $_POST["year"];
	//test that all required fields are filled
	if($test_id == "" || $duration == "" || $mark == "" || $no_of_questions == "" || $day == "" || 
			$day == "day" || $mon == "" || $mon == "month" || $year == "" || $year == "year"){
		$display = "<p>Please filled out all the input field to process your request</p>";
	}	else	{
		$deadline = "$year-$mon-$day:00:00:00";
		$duration = "00:$duration:00";
		$course_id = trim($_POST["course_id"]);
		if($course_id == ""){
			$display = "<p>There was an error processing your request. Please go back and try again at this point</p>";
		}	else	{
			$test_type = $_POST["test_type"];
			if(isset($_POST["set"])){
				//get the num of available question for either test or exam
				if($test_type == "test"){
					$query_string = "select * from questions where test_id = \"$test_id\" and course_id = \"$course_id\" and lec_id = \"$owner_id\"";
				}
				if($test_type == "exam"){
					$query_string = "select * from questions where course_id = \"$course_id\" and lec_id = \"$owner_id\"";
				}
				run_query($query_string);
				if($row_num2 < $no_of_questions){
					$display = "<p>The number of questions you set for the tests is greater that the questions you have save for this test<p>";
				}		else		{
					//verify the test/exam does not already exist
					//if($type == "test"){
					$query_string = "select * from tests where course_id = \"$course_id\" and test_id = \"$test_id\" and test_type = \"$test_type\" and lec_id = \"$owner_id\"";
					run_query($query_string);

					if($row_num2 == 1){		//the test already exist
						$end_year = date("Y");
						date_field("deadline", 31, 12, 2030, $end_year);		//call function to get date
						$display = <<<block
						<p> This test specification already exist. Do you want to edit it?</p>
						<form name = "test_specification" method = "POST" action = "$_SERVER[PHP_SELF]">
						<input type = "hidden" name = "test_type" value = "$test_type" />
						<input type = "hidden" name = "course_id" value = "$course_id" />
						<input type = "hidden" name = "test_id" value = "$test_id" />
						<input type = "submit" class = "btn btn-primary" id = "editTest" name = "edit_test" value = "Edit" />
						</form>
block;
					}	else 	{
						$query_string = "insert into tests set id = \"null\", lec_id = \"$owner_id\", test_id = \"$test_id\", course_id = \"$course_id\", duration = \"$duration\",
								deadline = \"$deadline\", mark = \"$mark\", no_of_questions = \"$no_of_questions\", test_type = \"$test_type\", test_status = \"closed\"";
						run_query($query_string);
						if($row_num2 == 0){
							$display = "<p>There was an error process your request. Please check you connection and try again</p>";
						}	else	{
							$display = "<p>The $test_type have been set</p>";
						}
					}
				}
			}		//end set	
			if(isset($_POST["update_test"])){
				$query_string = "update tests set duration = \"$duration\", deadline = \"$deadline\", mark = \"$mark\", no_of_questions = \"$no_of_questions\" where test_id = \"$test_id\" and course_id = \"$course_id\" and test_type = \"$test_type\" and lec_id = \"$owner_id\"";
				run_query($query_string);
				if($row_num2 == 0){
					$display = "<p>There was an error process your request. Please check you connection and try again here</p>";
				}	else	{
					$display = "<p>The test have been set</p>";
				}
			}	//end update_test
		}
	}
}






if(isset($_POST["view_test"])){
	$course_id = trim($_POST["course_id"]);
	if($course_id == ""){
		$display = "<p>Please select the course code to view tests you have set for the course</p>";
	} 	else	{
		$query_string = "select course_code from courses where course_id = \"$course_id\" and lec_id = \"$owner_id\"";
		run_query($query_string);
		if($row_num2 ==0 ) {
			$display = "<p>The course code for select test could not be fetched</p>";
		}	else 	{
			$course_code = build_array($row_num2);
			$query_string = "select test_id, date_format(duration, \"%i\"), date_format(deadline, \"%H:%i %p. %W, %D of %M, %Y\"), mark, no_of_questions, test_type, test_status from tests where course_id = \"$course_id\" and lec_id = \"$owner_id\"";
			run_query($query_string);
			if($row_num2 == 0){
				$display = "<p>You have not set any test for this course</p>";
			}	else	{
				$heading = "<h1>Tests you have set for $course_code</h1>";
				$tests = build_array($row_num2);
				if($row_num2 == 1) {
					$tests = [$tests];
				}
				$all_test = [];
				foreach ($tests as $test) {			//check for test or exam
					if(strtolower($test[5]) == "exam"){
						$test[0] = $test[0]. " exam";
					}	else if (strtolower($test[5]) == "test"){
						$test[0] = $test[0]. " test";
					}
					$all_test[] = $test;
				}
				$tests = $all_test;
				$fields = array ("test id", "duration (mins)", "deadline", "mark", "no of Questions", "test type", "test status");	
				array_unshift($tests, $fields);
				$table_values = mytable($tests, "yes", "yes");
				$display =<<<block
				<p>Select a test to perform an action</p>
				<form name "test_specification" method = "POST" action = "$_SERVER[PHP_SELF]" >
				<input type = "hidden" name = "course_id" value = "$course_id" />
				$table_values
				<input type = "submit" class = "btn btn-primary" id = "openTest" name = "open_test" value = "Open Test" />
				<input type = "submit" class = "btn btn-secondary" id = "closeTest" name = "close_test" value = "Close Test" />
				<input type = "submit" class = "btn btn-warn" id = "editTest" name = "edit_test" value = "Edit Test" />
				<input  type = "submit" class = "btn btn-danger" id = "deleteTest" name = "delete_test" value = "Delete" />
				</form>
block;
			}
		}
	}
}

if(isset($_POST["open_test"]) || isset($_POST["close_test"])){
	//get course_id and test_id
	if(empty($_POST["test_id"])){
		$display = "<p>Please select a test/exam</p>";
	}	else 	{
		$test_ind = $_POST["test_id"][0];
		$test_ind = explode(" ", $test_ind);
		$test_id = $test_ind[0];
		$test_type = $test_ind[1];
		$course_id = $_POST["course_id"];
		if($test_id == "" || $course_id == ""){
			$display = "<p>Test id and/or course id is not set </p>";
		}	else 	{
			if(isset($_POST["open_test"])){
				$condition = "Opened";
				$query_string = "update tests set test_status = \"opened\" where course_id = \"$course_id\" and test_id = \"$test_id\" and test_type = \"$test_type\" and lec_id = \"$owner_id\"";
			}
			if(isset($_POST["close_test"])){
				$condition = "Closed";
				$query_string = "update tests set test_status = \"closed\" where course_id = \"$course_id\" and test_id = \"$test_id\" and test_type = \"$test_type\" and lec_id = \"$owner_id\"";
			}
			run_query($query_string);
			if($row_num2 == 0) {
				$display = "<p>The $test_type could not be $condition</p>";
			}	else 	{
				$display = "<p> The $test_type has been $condition </p>";
			}
		}
	}
}

if(isset($_POST["delete_test"])){
	if(empty($_POST["test_id"])){
		$display = "<p>Please select a test to delete</p>";
	}	else	{
		$test_ind = trim($_POST["test_id"][0]);
		$test_ind = explode(" ", $test_ind);
		$test_id = $test_ind[0];
		$test_type = $test_ind[1];
		$course_id = trim($_POST["course_id"]);
		$query_string = "delete from tests where test_id = \"$test_id\" and course_id = \"$course_id\" and test_type  = \"$test_type\" and lec_id = \"$owner_id\"";
		run_query($query_string);
		if($row_num2 == 0 ){
			$display = "<p>This test does not exist. No action taken</p>";
		}	else 	{
			$heading = "<h1>Delete result</h1>";
			$display = "<p>The test has been removed from the record</p>";
		}
	}
}

}	else {			
header("Location:/onlinetutor/login.php");  		//user do not have an active session
exit();
}
?>

<?php echo $heading; ?>
<?php echo $display; ?>
